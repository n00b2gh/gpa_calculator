<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title> GPA Calculator (Offline)</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #2c3e50;
            text-align: center;
        }
        .control-panel {
            background-color: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }
        input, select, button {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            flex-grow: 1;
        }
        button:hover {
            background-color: #2980b9;
        }
        #saveBtn {
            background-color: #27ae60;
        }
        #saveBtn:hover {
            background-color: #219653;
        }
        #editBtn {
            background-color: #f39c12;
        }
        #editBtn:hover {
            background-color: #e67e22;
        }
        #importBtn {
            background-color: #9b59b6;
        }
        #importBtn:hover {
            background-color: #8e44ad;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background-color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        th {
            background-color: #f2f2f2;
        }
        .overall-row {
            font-weight: bold;
            background-color: #eaf7ff;
        }
        .semester-header {
            background-color: #2c3e50;
            color: white;
            margin-top: 30px;
            padding: 10px;
            border-radius: 4px;
        }
        .action-btn {
            padding: 5px 10px;
            font-size: 14px;
            margin: 0 2px;
        }
        .edit-btn {
            background-color: #3498db;
        }
        .delete-btn {
            background-color: #e74c3c;
        }
        .add-btn {
            background-color: #2ecc71;
        }
        .file-input {
            display: none;
        }
        .semester-selector {
            margin-bottom: 10px;
        }
        .summary-table {
            width: 100%;
            margin-top: 20px;
        }
        .main-subject-select {
            flex-grow: 1;
            min-width: 150px;
        }
        @media (max-width: 600px) {
            .input-group {
                flex-direction: column;
            }
            .main-subject-select {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <h1>GPA Calculator</h1>
    
    <!-- Main Subjects Selection Panel -->
    <div class="control-panel" id="mainSubjectsPanel">
        <div class="input-group">
            <select id="mainSubject1" class="main-subject-select">
                <option value="" disabled selection >Select Subject</option>
                <option value="Mathematics">Mathematics</option>
                <option value="Applied Mathematics">Applied Mathematics</option>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Industrial Mathematics">Industrial Mathematics</option>
                <option value="Zoology">Zoology</option>
                <option value="FSC">FSC</option>
            </select>
            <select id="mainSubject2" class="main-subject-select">
                <option value="Mathematics">Mathematics</option>
                <option value="Applied Mathematics">Applied Mathematics</option>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Industrial Mathematics">Industrial Mathematics</option>
                <option value="Zoology">Zoology</option>
                <option value="FSC">FSC</option>
            </select>
            <select id="mainSubject3" class="main-subject-select">
                <option value="Mathematics">Mathematics</option>
                <option value="Applied Mathematics">Applied Mathematics</option>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Industrial Mathematics">Industrial Mathematics</option>
                <option value="Zoology">Zoology</option>
                <option value="FSC">FSC</option>
            </select>
        </div>
    </div>
    
    <div class="control-panel">
        <div class="input-group">
            <input type="text" id="courseInput" placeholder="Course Name" style="flex-grow: 2;">
            <select id="subjectStreamSelect">
                <option value="Mathematics" selected>Mathematics</option>
                <option value="Applied Mathematics">Applied Mathematics</option>
                <option value="Physics">Physics</option>
                <option value="Chemistry">Chemistry</option>
                <option value="Computer Science">Computer Science</option>
                <option value="Industrial Mathematics">Industrial Mathematics</option>
                <option value="Zoology">Zoology</option>
                <option value="FSC">FSC</option>
            </select>
            <select id="creditsSelect">
                <option value="1.0" selected>1.0 Credit</option>
                <option value="1.25">1.25 Credits</option>
                <option value="1.5">1.5 Credits</option>
                <option value="2.0">2.0 Credits</option>
                <option value="2.5">2.5 Credits</option>
                <option value="3.0">3.0 Credits</option>
                <option value="4.0">4.0 Credits</option>
            </select>
            <select id="gradeSelect">
                <option value="A+" selected>A+ (85-100)</option>
                <option value="A">A (70-84)</option>
                <option value="A-">A- (65-69)</option>
                <option value="B+">B+ (60-64)</option>
                <option value="B">B (55-59)</option>
                <option value="B-">B- (50-54)</option>
                <option value="C+">C+ (45-49)</option>
                <option value="C">C (40-44)</option>
                <option value="C-">C- (35-39)</option>
                <option value="D+">D+ (30-34)</option>
                <option value="D">D (25-29)</option>
                <option value="E">E (0-24)</option>
            </select>
        </div>
        <div class="input-group semester-selector" id="semesterSelector" style="display: none;">
            <select id="semesterSelect">
                <option value="Semester 1">Semester 1</option>
                <option value="Semester 2">Semester 2</option>
                <option value="Semester 3">Semester 3</option>
                <option value="Semester 4">Semester 4</option>
                <option value="Semester 5">Semester 5</option>
                <option value="Semester 6">Semester 6</option>
            </select>
        </div>
        <div class="input-group">
            <button id="addBtn">Add Course</button>
            <button id="nextSemesterBtn">Next Semester</button>
            <button id="saveBtn">Export CSV</button>
            <button id="importBtn">Import CSV</button>
            <button id="editBtn">Edit Mode</button>
        </div>
        <input type="file" id="fileInput" class="file-input" accept=".csv">
    </div>

    <div id="resultsContainer"></div>

    <script>
        // Grading system (Sri Lankan)
        const gradingScale = {
            "A+": 4.0, "A": 4.0, "A-": 3.7,
            "B+": 3.3, "B": 3.0, "B-": 2.7,
            "C+": 2.3, "C": 2.0, "C-": 1.7,
            "D+": 1.3, "D": 1.0, "E": 0.0
        };

        // Subject streams
        const subjectStreams = ["Mathematics", "Applied Mathematics", "Physics", "Chemistry", "Computer Science", "Industrial Mathematics", "Zoology", "FSC"];

        // Data structure
        let semesters = {};
        for (let i = 1; i <= 6; i++) {
            semesters[`Semester ${i}`] = { subjects: [] };
        }
        let currentSemester = "Semester 1";
        let editMode = false;
        let currentlyEditing = null;
        let mainSubjects = ["Mathematics", "Mathematics", "Mathematics"];

        // DOM elements
        const courseInput = document.getElementById("courseInput");
        const subjectStreamSelect = document.getElementById("subjectStreamSelect");
        const creditsSelect = document.getElementById("creditsSelect");
        const gradeSelect = document.getElementById("gradeSelect");
        const semesterSelect = document.getElementById("semesterSelect");
        const semesterSelector = document.getElementById("semesterSelector");
        const addBtn = document.getElementById("addBtn");
        const nextSemesterBtn = document.getElementById("nextSemesterBtn");
        const saveBtn = document.getElementById("saveBtn");
        const importBtn = document.getElementById("importBtn");
        const editBtn = document.getElementById("editBtn");
        const fileInput = document.getElementById("fileInput");
        const resultsContainer = document.getElementById("resultsContainer");
        const mainSubject1 = document.getElementById("mainSubject1");
        const mainSubject2 = document.getElementById("mainSubject2");
        const mainSubject3 = document.getElementById("mainSubject3");

        // Initialize main subjects
        mainSubject1.value = "Mathematics";
        mainSubject2.value = "Mathematics";
        mainSubject3.value = "Mathematics";

        // Helper function to round numbers precisely
        function preciseRound(num, decimals = 2) {
            return parseFloat(num.toFixed(decimals));
        }

        // Calculate GPA for a list of subjects
        function calculateGPA(subjects) {
            let totalGradePoints = 0;
            let totalCredits = 0;
            
            subjects.forEach(subject => {
                totalGradePoints += subject.gradePoints * subject.credits;
                totalCredits += subject.credits;
            });
            
            return totalCredits > 0 ? preciseRound(totalGradePoints / totalCredits) : 0;
        }

        // Update main subjects selection
        function updateMainSubjects() {
            mainSubjects = [
                mainSubject1.value || null,
                mainSubject2.value || null,
                mainSubject3.value || null
            ];
            
            // Ensure no duplicates
            const uniqueSubjects = [...new Set(mainSubjects.filter(s => s))];
            if (uniqueSubjects.length < mainSubjects.filter(s => s).length) {
                alert("Please select three different main subjects");
                return false;
            }
            
            displayResults();
            return true;
        }

        // Display all semesters
        function displayResults() {
            resultsContainer.innerHTML = "";
            let allSubjects = [];
            
            // Generate HTML for each semester
            for (const [semesterName, semesterData] of Object.entries(semesters)) {
                if (semesterData.subjects.length === 0 && !editMode) continue;
                
                const semesterGPA = calculateGPA(semesterData.subjects);
                const semesterCredits = preciseRound(semesterData.subjects.reduce((sum, subject) => sum + subject.credits, 0));
                
                let html = `
                    <div class="semester-header">
                        ${semesterName} - GPA: ${semesterGPA} | Credits: ${semesterCredits}
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>Course</th>
                                <th>Subject</th>
                                <th>Grade</th>
                                <th>Credits</th>
                                ${editMode ? '<th>Actions</th>' : ''}
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                semesterData.subjects.forEach((subject, index) => {
                    html += `
                        <tr>
                            <td>${subject.course}</td>
                            <td>${subject.subjectStream}</td>
                            <td>${subject.grade}</td>
                            <td>${preciseRound(subject.credits)}</td>
                            ${editMode ? 
                                `<td>
                                    <button class="action-btn edit-btn" 
                                        onclick="startEditing('${semesterName}', ${index})">Edit</button>
                                    <button class="action-btn delete-btn" 
                                        onclick="deleteCourse('${semesterName}', ${index})">Delete</button>
                                </td>` 
                                : ''}
                        </tr>
                    `;
                    allSubjects.push({...subject, semester: semesterName});
                });
                
                // Add course button in edit mode
                if (editMode) {
                    html += `
                        <tr>
                            <td colspan="${editMode ? '5' : '4'}" style="text-align: center;">
                                <button class="action-btn add-btn" 
                                    onclick="showAddForm('${semesterName}')">+ Add Course</button>
                            </td>
                        </tr>
                    `;
                }
                
                html += `
                        </tbody>
                    </table>
                `;
                
                resultsContainer.innerHTML += html;
            }
            
            // Calculate and display overall GPA if we have data
            if (allSubjects.length > 0) {
                const overallGPA = calculateGPA(allSubjects);
                const totalCredits = preciseRound(allSubjects.reduce((sum, subject) => sum + subject.credits, 0));
                
                // Create summary table
                let summaryHTML = `
                    <div class="semester-header">
                        OVERALL RESULTS - GPA: ${overallGPA} | Total Credits: ${totalCredits}
                    </div>
                    <table class="summary-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>GPA</th>
                                <th>Credits</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                // Add rows for main subjects and Other
                const displaySubjects = [...mainSubjects.filter(s => s), "Other"];
                displaySubjects.forEach(stream => {
                    let streamSubjects;
                    if (stream === "Other") {
                        streamSubjects = allSubjects.filter(subject => 
                            !mainSubjects.includes(subject.subjectStream));
                    } else {
                        streamSubjects = allSubjects.filter(subject => 
                            subject.subjectStream === stream);
                    }
                    
                    if (streamSubjects.length > 0) {
                        const streamGPA = calculateGPA(streamSubjects);
                        const streamCredits = preciseRound(streamSubjects.reduce((sum, subject) => sum + subject.credits, 0));
                        
                        summaryHTML += `
                            <tr>
                                <td>${stream}</td>
                                <td>${streamGPA}</td>
                                <td>${streamCredits}</td>
                            </tr>
                        `;
                    }
                });
                
                // Add overall row
                summaryHTML += `
                            <tr class="overall-row">
                                <td><strong>OVERALL</strong></td>
                                <td><strong>${overallGPA}</strong></td>
                                <td><strong>${totalCredits}</strong></td>
                            </tr>
                        </tbody>
                    </table>
                `;
                
                resultsContainer.innerHTML += summaryHTML;
            }
        }

        // Start editing a course
        window.startEditing = function(semesterName, index) {
            const course = semesters[semesterName].subjects[index];
            
            // Fill the form with existing values
            courseInput.value = course.course;
            subjectStreamSelect.value = course.subjectStream;
            creditsSelect.value = course.credits.toString();
            gradeSelect.value = course.grade;
            semesterSelect.value = semesterName;
            
            // Show the semester selector
            semesterSelector.style.display = 'flex';
            
            // Change button to "Update Course"
            addBtn.textContent = "Update Course";
            
            // Store what we're editing
            currentlyEditing = { semesterName, index };
            
            // Focus on course name for quick editing
            courseInput.focus();
        };

        // Show add form for specific semester
        window.showAddForm = function(semesterName) {
            // Reset form
            courseInput.value = "";
            subjectStreamSelect.value = "Mathematics";
            creditsSelect.value = "1.0";
            gradeSelect.value = "A+";
            semesterSelect.value = semesterName;
            
            // Show the semester selector
            semesterSelector.style.display = 'flex';
            
            // Change button back to "Add Course"
            addBtn.textContent = "Add Course";
            currentlyEditing = null;
            
            // Focus on course name
            courseInput.focus();
        };

        // Delete course function
        window.deleteCourse = function(semesterName, index) {
            if (confirm(`Delete ${semesters[semesterName].subjects[index].course}?`)) {
                semesters[semesterName].subjects.splice(index, 1);
                displayResults();
            }
        };

        // Toggle edit mode
        editBtn.addEventListener("click", () => {
            editMode = !editMode;
            editBtn.textContent = editMode ? "Exit Edit Mode" : "Edit Mode";
            editBtn.style.backgroundColor = editMode ? "#e67e22" : "#f39c12";
            semesterSelector.style.display = editMode ? 'flex' : 'none';
            
            // Reset any editing in progress
            if (!editMode) {
                addBtn.textContent = "Add Course";
                currentlyEditing = null;
            }
            
            displayResults();
        });

        // Add/Update course handler
        addBtn.addEventListener("click", () => {
            const course = courseInput.value.trim();
            const subjectStream = subjectStreamSelect.value;
            const credits = preciseRound(parseFloat(creditsSelect.value));
            const grade = gradeSelect.value;
            const semester = semesterSelect.value;
            
            if (!course) {
                alert("Please enter a course name!");
                return;
            }
            
            if (semesters[semester].subjects.length >= 10 && !currentlyEditing) {
                alert("Maximum 10 courses per semester!");
                return;
            }
            
            if (currentlyEditing) {
                // Update existing course
                const { semesterName, index } = currentlyEditing;
                semesters[semesterName].subjects[index] = {
                    course,
                    subjectStream,
                    grade,
                    credits,
                    gradePoints: gradingScale[grade]
                };
            } else {
                // Add new course
                semesters[semester].subjects.push({
                    course,
                    subjectStream,
                    grade,
                    credits,
                    gradePoints: gradingScale[grade]
                });
            }
            
            // Reset form
            courseInput.value = "";
            currentlyEditing = null;
            addBtn.textContent = "Add Course";
            
            displayResults();
        });

        nextSemesterBtn.addEventListener("click", () => {
            const currentSemesterNumber = parseInt(currentSemester.split(" ")[1]);
            
            if (currentSemesterNumber < 6) {
                currentSemester = `Semester ${currentSemesterNumber + 1}`;
                semesterSelect.value = currentSemester;
                alert(`Now entering ${currentSemester}`);
                displayResults();
            } else {
                alert("All 6 semesters completed!");
            }
        });

        importBtn.addEventListener("click", () => {
            fileInput.click();
        });

        fileInput.addEventListener("change", (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const lines = content.split('\n').slice(1); // Skip header
                    
                    // Reset all semesters
                    for (let i = 1; i <= 6; i++) {
                        semesters[`Semester ${i}`] = { subjects: [] };
                    }
                    
                    // Process each line
                    lines.forEach(line => {
                        if (!line.trim()) return;
                        
                        // Handle quoted CSV values
                        const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g);
                        if (!values || values.length < 5) return;
                        
                        const semester = values[0].replace(/"/g, '');
                        const course = values[1].replace(/"/g, '');
                        const subjectStream = values[2] ? values[2].replace(/"/g, '') : "Mathematics";
                        const grade = values[3].replace(/"/g, '');
                        const credits = preciseRound(parseFloat(values[4]));
                        const gpaPoints = preciseRound(parseFloat(values[5]));
                        
                        // Skip the OVERALL row
                        if (semester === "OVERALL" || semester === "ALL") return;
                        
                        if (semesters[semester]) {
                            semesters[semester].subjects.push({
                                course,
                                subjectStream,
                                grade,
                                credits,
                                gradePoints: gpaPoints
                            });
                        }
                    });
                    
                    // Find the last semester with data
                    let lastSemester = "Semester 1";
                    for (let i = 6; i >= 1; i--) {
                        if (semesters[`Semester ${i}`].subjects.length > 0) {
                            lastSemester = `Semester ${i}`;
                            break;
                        }
                    }
                    currentSemester = lastSemester;
                    
                    // Detect most frequent subjects for main selection
                    const subjectCounts = {};
                    const allSubjects = Object.values(semesters).flatMap(sem => sem.subjects);
                    allSubjects.forEach(subject => {
                        subjectCounts[subject.subjectStream] = (subjectCounts[subject.subjectStream] || 0) + 1;
                    });

                    const sortedSubjects = Object.entries(subjectCounts)
                        .sort((a, b) => b[1] - a[1])
                        .map(([subject]) => subject)
                        .slice(0, 3);

                    // Set main subjects
                    mainSubject1.value = sortedSubjects[0] || "Mathematics";
                    mainSubject2.value = sortedSubjects[1] || "Mathematics";
                    mainSubject3.value = sortedSubjects[2] || "Mathematics";
                    updateMainSubjects();
                    
                    displayResults();
                    alert("Data imported successfully!");
                } catch (error) {
                    alert("Error importing CSV file. Please use the exported format.");
                    console.error(error);
                }
            };
            reader.readAsText(file);
        });

        saveBtn.addEventListener("click", () => {
            // Prepare data for export
            let csvContent = "MainSubject1,MainSubject2,MainSubject3,Semester,Course,Subject,Grade,Credits,GPA Points\n";
            
            for (const [semesterName, semesterData] of Object.entries(semesters)) {
                semesterData.subjects.forEach(subject => {
                    csvContent += `"${mainSubjects[0] || ''}","${mainSubjects[1] || ''}","${mainSubjects[2] || ''}",` +
                        `"${semesterName}","${subject.course}","${subject.subjectStream}","${subject.grade}",` +
                        `${preciseRound(subject.credits)},${preciseRound(subject.gradePoints)}\n`;
                });
            }
            
            // Calculate overall
            const allSubjects = Object.values(semesters).flatMap(sem => sem.subjects);
            if (allSubjects.length > 0) {
                const overallGPA = calculateGPA(allSubjects);
                const totalCredits = preciseRound(allSubjects.reduce((sum, subject) => sum + subject.credits, 0));
                csvContent += `"${mainSubjects[0] || ''}","${mainSubjects[1] || ''}","${mainSubjects[2] || ''}",` +
                    `"OVERALL","OVERALL GPA","","",${totalCredits},${overallGPA}\n`;
            }
            
            // Create download link
            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "gpa_results.csv");
            link.style.visibility = "hidden";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            alert("Results exported to gpa_results.csv");
        });

        // Event listeners for main subject dropdowns
        mainSubject1.addEventListener("change", updateMainSubjects);
        mainSubject2.addEventListener("change", updateMainSubjects);
        mainSubject3.addEventListener("change", updateMainSubjects);

        // Initial display
        displayResults();
    </script>
</body>
</html>